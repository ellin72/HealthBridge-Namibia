// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PATIENT
  HEALTHCARE_PROVIDER
  WELLNESS_COACH
  STUDENT
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum WellnessCategory {
  NUTRITION
  FITNESS
  STRESS_MANAGEMENT
}

enum AssignmentStatus {
  PENDING
  SUBMITTED
  GRADED
}

enum VideoProvider {
  ZOOM
  GOOGLE_MEET
  CUSTOM
}

enum HabitType {
  NUTRITION
  FITNESS
  SLEEP
  MEDITATION
  HYDRATION
  OTHER
}

enum ChallengeStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum ResearchField {
  HEALTH
  EDUCATION
  TECHNOLOGY
  AGRICULTURE
  BUSINESS
  SOCIAL_SCIENCES
  OTHER
}

enum ProposalStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  REVISED
}

enum MilestoneType {
  PROPOSAL
  ETHICS_APPROVAL
  DATA_COLLECTION
  ANALYSIS
  FINAL_SUBMISSION
}

enum MilestoneStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum CollaborationType {
  FOLDER
  NOTE
  CHAT
}

enum Language {
  ENGLISH
  OSHIWAMBO
  AFRIKAANS
}

enum MedicalAidScheme {
  NAMMED
  MEDICAL_AID_FUND
  PROSANA
  OTHER
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYTODAY
  SNAPSCAN
  MOBILE_MONEY
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum TriageUrgency {
  LOW
  MEDIUM
  HIGH
  URGENT
  EMERGENCY
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  role          UserRole
  isActive      Boolean  @default(true)
  preferredLanguage Language @default(ENGLISH)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  appointmentsAsPatient    Appointment[] @relation("PatientAppointments")
  appointmentsAsProvider   Appointment[] @relation("ProviderAppointments")
  consultationNotes        ConsultationNote[]
  wellnessContent          WellnessContent[]
  assignments              Assignment[]
  submittedAssignments     AssignmentSubmission[]
  
  // Phase 2 Relations
  patientHistory           PatientHistory[]
  wellnessPlans            WellnessPlan[]
  habitTrackers            HabitTracker[]
  challengeParticipations  ChallengeParticipation[]
  researchTopics           ResearchTopic[]
  researchProposals        ResearchProposal[]
  supervisorMatches        SupervisorMatch[] @relation("StudentSupervisorMatches")
  supervisorMatchesAsSupervisor SupervisorMatch[] @relation("SupervisorMatches")
  researchMilestones       ResearchMilestone[]
  researchCollaborations   ResearchCollaboration[]
  
  // Phase 3: Tips.md Improvements
  medicalAidInfo           MedicalAidInfo?
  triageAssessments        TriageAssessment[]
  payments                 Payment[]
  offlineSyncQueue         OfflineSyncQueue[]
  
  // Dashboard Enhancements
  medicationReminders      MedicationReminder[] @relation("PatientMedications")
  invoicesAsPatient        BillingInvoice[] @relation("PatientInvoices")
  invoicesAsProvider        BillingInvoice[] @relation("ProviderInvoices")
  clinicalTemplates         ClinicalTemplate[] @relation("ProviderTemplates")
  remoteMonitoringData      RemoteMonitoringData[] @relation("PatientMonitoring")
  
  // Billing System Enhancements
  providerFee              ProviderFee?
  subscriptions           Subscription[] @relation("SubscriberSubscriptions")
  subscriptionPayments    SubscriptionPayment[]
  twoFactorAuth           TwoFactorAuth?

  @@index([email])
  @@index([role])
  @@index([preferredLanguage])
}

model Appointment {
  id            String            @id @default(uuid())
  patientId     String
  providerId    String
  appointmentDate DateTime
  status        AppointmentStatus @default(PENDING)
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  patient       User              @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Cascade)
  provider      User              @relation("ProviderAppointments", fields: [providerId], references: [id], onDelete: Cascade)
  consultationNotes ConsultationNote[]
  videoConsultation VideoConsultation?

  @@index([patientId])
  @@index([providerId])
  @@index([appointmentDate])
}

model ConsultationNote {
  id            String   @id @default(uuid())
  appointmentId String
  providerId    String
  patientId     String
  notes         String
  diagnosis     String?
  prescription  String?
  followUpDate  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  provider      User        @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([patientId])
}

model WellnessContent {
  id            String           @id @default(uuid())
  title         String
  description   String
  category      WellnessCategory
  content       String           // Rich text or markdown
  imageUrl      String?
  videoUrl      String?
  authorId      String
  isPublished   Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  author        User             @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([isPublished])
}

model LearningResource {
  id            String   @id @default(uuid())
  title         String
  description   String?
  fileUrl       String
  fileName      String
  fileSize      Int
  mimeType      String
  uploadedBy    String
  isPublished   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isPublished])
}

model Assignment {
  id            String            @id @default(uuid())
  title         String
  description   String
  dueDate       DateTime
  instructorId  String
  fileUrl       String?           // Assignment file/instructions
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  instructor    User              @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  submissions   AssignmentSubmission[]

  @@index([instructorId])
  @@index([dueDate])
}

model AssignmentSubmission {
  id            String            @id @default(uuid())
  assignmentId  String
  studentId     String
  fileUrl       String
  fileName      String
  fileSize      Int
  mimeType      String
  status        AssignmentStatus  @default(SUBMITTED)
  grade         Float?
  feedback      String?
  submittedAt   DateTime          @default(now())
  gradedAt      DateTime?
  updatedAt     DateTime          @updatedAt

  assignment    Assignment        @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student       User              @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@index([studentId])
  @@unique([assignmentId, studentId])
}

// ========== PHASE 2: TELEHEALTH PRO ==========

model VideoConsultation {
  id              String          @id @default(uuid())
  appointmentId   String          @unique
  provider        VideoProvider   @default(ZOOM)
  meetingUrl      String
  meetingId       String?
  meetingPassword String?
  startTime       DateTime?
  endTime         DateTime?
  duration        Int?            // in minutes
  recordingUrl    String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  appointment     Appointment     @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
}

model PatientHistory {
  id              String          @id @default(uuid())
  patientId       String
  providerId      String?
  medicalHistory  String?         // JSON or text
  allergies       String?         // JSON array
  medications     String?         // JSON array
  vitalSigns      String?         // JSON object
  labResults      String?         // JSON array
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  patient         User            @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([providerId])
}

// ========== PHASE 2: INTERACTIVE WELLNESS TOOLS ==========

model WellnessPlan {
  id              String          @id @default(uuid())
  userId          String
  title           String
  description     String
  goals           String          // JSON array of goals
  startDate       DateTime
  endDate         DateTime?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model HabitTracker {
  id              String          @id @default(uuid())
  userId          String
  habitType       HabitType
  habitName       String
  targetValue     Float?          // e.g., 8 hours of sleep, 2L water
  unit            String?         // e.g., "hours", "liters", "meals"
  currentStreak   Int             @default(0)
  longestStreak   Int             @default(0)
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries         HabitEntry[]

  @@index([userId])
  @@index([habitType])
  @@index([isActive])
}

model HabitEntry {
  id              String          @id @default(uuid())
  habitTrackerId  String
  date            DateTime        @default(now())
  value           Float
  notes           String?
  createdAt       DateTime        @default(now())

  habitTracker    HabitTracker    @relation(fields: [habitTrackerId], references: [id], onDelete: Cascade)

  @@index([habitTrackerId])
  @@index([date])
  @@unique([habitTrackerId, date])
}

model WellnessChallenge {
  id              String          @id @default(uuid())
  title           String
  description     String
  category        WellnessCategory
  startDate       DateTime
  endDate         DateTime
  targetGoal      String          // e.g., "30 days of exercise"
  reward          String?
  status          ChallengeStatus @default(UPCOMING)
  createdBy       String?         // Admin or Wellness Coach ID
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  participations  ChallengeParticipation[]

  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model ChallengeParticipation {
  id              String          @id @default(uuid())
  challengeId     String
  userId          String
  progress        Int             @default(0) // percentage or count
  completed       Boolean         @default(false)
  joinedAt        DateTime        @default(now())
  completedAt     DateTime?

  challenge       WellnessChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([challengeId])
  @@index([userId])
  @@unique([challengeId, userId])
}

// ========== PHASE 2: RESEARCH SUPPORT SECTION ==========

model ResearchTopic {
  id              String          @id @default(uuid())
  userId          String
  field           ResearchField
  topic           String
  description     String?
  keywords        String?         // JSON array
  isGenerated     Boolean         @default(false) // AI-generated or user-created
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  proposals       ResearchProposal[]

  @@index([userId])
  @@index([field])
}

model ResearchProposal {
  id              String          @id @default(uuid())
  topicId         String?
  userId          String
  title            String
  abstract         String
  objectives       String          // JSON array
  methodology      String
  expectedOutcomes String?
  status           ProposalStatus  @default(DRAFT)
  fileUrl          String?         // Uploaded proposal document
  submittedAt      DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  topic            ResearchTopic?  @relation(fields: [topicId], references: [id], onDelete: SetNull)
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  milestones       ResearchMilestone[]

  @@index([userId])
  @@index([status])
  @@index([topicId])
}

model ResearchResource {
  id              String          @id @default(uuid())
  title           String
  description     String?
  field           ResearchField
  resourceType    String          // "article", "journal", "dataset", "book", etc.
  url             String?
  fileUrl         String?
  fileName        String?
  author          String?
  publisher       String?
  publishedDate   DateTime?
  tags            String?         // JSON array
  isPublic        Boolean         @default(true)
  uploadedBy      String?         // User ID if uploaded
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([field])
  @@index([resourceType])
  @@index([isPublic])
}

model SupervisorMatch {
  id              String          @id @default(uuid())
  studentId       String
  supervisorId    String
  field           ResearchField
  status          String          @default("PENDING") // PENDING, ACCEPTED, REJECTED, ACTIVE, COMPLETED
  requestMessage  String?
  responseMessage String?
  matchedAt       DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  student         User            @relation("StudentSupervisorMatches", fields: [studentId], references: [id], onDelete: Cascade)
  supervisor      User            @relation("SupervisorMatches", fields: [supervisorId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([supervisorId])
  @@index([status])
  @@unique([studentId, supervisorId])
}

model ResearchMilestone {
  id              String          @id @default(uuid())
  proposalId      String
  userId          String
  milestoneType   MilestoneType
  title           String
  description     String?
  dueDate         DateTime?
  status          MilestoneStatus @default(NOT_STARTED)
  completedAt     DateTime?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  proposal        ResearchProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([userId])
  @@index([status])
  @@index([milestoneType])
}

model ResearchCollaboration {
  id              String          @id @default(uuid())
  proposalId      String?         // Optional - can be standalone
  userId          String
  collaborationType CollaborationType
  title           String
  content         String          // For notes/chat messages
  fileUrl         String?         // For shared files
  parentId        String?         // For nested folders/threads
  isShared        Boolean         @default(false)
  sharedWith      String?         // JSON array of user IDs
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([proposalId])
  @@index([collaborationType])
  @@index([parentId])
}

// ========== PHASE 3: TIPS.MD IMPROVEMENTS ==========

model MedicalAidInfo {
  id              String          @id @default(uuid())
  userId          String          @unique
  scheme          MedicalAidScheme
  schemeName      String?         // For OTHER scheme
  memberNumber    String
  policyNumber    String?
  isActive        Boolean         @default(true)
  verifiedAt      DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  claims          MedicalAidClaim[]

  @@index([userId])
  @@index([scheme])
  @@index([memberNumber])
}

model MedicalAidClaim {
  id              String          @id @default(uuid())
  medicalAidInfoId String
  appointmentId  String?
  claimNumber    String          @unique
  amount         Float
  status         String          // PENDING, APPROVED, REJECTED, PAID
  submittedAt    DateTime        @default(now())
  processedAt    DateTime?
  notes          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  medicalAidInfo MedicalAidInfo  @relation(fields: [medicalAidInfoId], references: [id], onDelete: Cascade)

  @@index([medicalAidInfoId])
  @@index([claimNumber])
  @@index([status])
}

model TriageAssessment {
  id              String          @id @default(uuid())
  userId          String
  symptoms        String          // JSON array of symptoms
  description     String?
  urgency         TriageUrgency
  aiRecommendation String?        // AI-generated recommendation
  aiConfidence    Float?          // 0-1 confidence score
  recommendedAction String?       // e.g., "See doctor within 24 hours"
  followUpDate    DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([urgency])
  @@index([createdAt])
}

model Payment {
  id              String          @id @default(uuid())
  userId          String
  invoiceId       String?         // Link to invoice
  appointmentId  String?
  amount          Float
  currency        String          @default("NAD")
  method          PaymentMethod
  status          PaymentStatus   @default(PENDING)
  transactionId  String?         // External payment gateway transaction ID
  paymentReference String?       // For mobile payments
  metadata        String?         // JSON for additional payment data
  requires2FA     Boolean         @default(false)
  twoFactorVerified Boolean       @default(false)
  encryptedCardData String?       // Encrypted card data (PCI-DSS compliant)
  completedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice         BillingInvoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  auditLogs       PaymentAuditLog[]

  @@index([userId])
  @@index([invoiceId])
  @@index([status])
  @@index([transactionId])
  @@index([paymentReference])
  @@index([createdAt])
}

enum SyncQueueStatus {
  PENDING
  PROCESSING
  SYNCED
  FAILED
}

model OfflineSyncQueue {
  id              String          @id @default(uuid())
  userId          String
  action          String          // CREATE, UPDATE, DELETE
  entityType      String          // APPOINTMENT, CONSULTATION, etc.
  entityId        String?
  payload         String          // JSON data
  synced          Boolean         @default(false)
  status          SyncQueueStatus @default(PENDING)
  syncedAt        DateTime?
  error           String?
  retryCount      Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([synced])
  @@index([status])
  @@index([createdAt])
}

model FHIRResource {
  id              String          @id @default(uuid())
  resourceType  String          // Patient, Observation, etc.
  fhirId          String          @unique
  resourceData   String          // JSON FHIR resource
  version         Int             @default(1)
  lastUpdated     DateTime        @default(now())
  createdAt       DateTime        @default(now())

  @@index([resourceType])
  @@index([fhirId])
  @@index([lastUpdated])
}

// ========== DASHBOARD ENHANCEMENTS ==========

enum MedicationFrequency {
  ONCE_DAILY
  TWICE_DAILY
  THREE_TIMES_DAILY
  FOUR_TIMES_DAILY
  AS_NEEDED
  WEEKLY
  MONTHLY
}

enum ReminderStatus {
  ACTIVE
  COMPLETED
  MISSED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model MedicationReminder {
  id              String            @id @default(uuid())
  patientId       String
  medicationName  String
  dosage          String            // e.g., "500mg", "1 tablet"
  frequency       MedicationFrequency
  times           String            // JSON array of times ["08:00", "20:00"]
  startDate       DateTime
  endDate         DateTime?
  notes           String?
  status          ReminderStatus    @default(ACTIVE)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  patient         User              @relation("PatientMedications", fields: [patientId], references: [id], onDelete: Cascade)
  logs            MedicationLog[]

  @@index([patientId])
  @@index([status])
  @@index([isActive])
  @@index([startDate])
}

model MedicationLog {
  id              String            @id @default(uuid())
  reminderId      String
  scheduledTime   DateTime
  takenTime       DateTime?
  status          String            // TAKEN, MISSED, SKIPPED
  notes           String?
  createdAt       DateTime          @default(now())

  reminder        MedicationReminder @relation(fields: [reminderId], references: [id], onDelete: Cascade)

  @@index([reminderId])
  @@index([scheduledTime])
  @@index([status])
}

model ClinicalTemplate {
  id              String            @id @default(uuid())
  providerId      String
  name            String
  category        String            // GENERAL, CARDIOLOGY, PEDIATRICS, etc.
  templateData    String            // JSON structure for the template
  isDefault        Boolean           @default(false)
  isShared         Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  provider        User              @relation("ProviderTemplates", fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([category])
  @@index([isDefault])
}

model BillingInvoice {
  id              String            @id @default(uuid())
  providerId      String
  patientId       String
  appointmentId   String?
  invoiceNumber   String            @unique
  items            String            // JSON array of line items
  subtotal         Float
  tax              Float             @default(0)
  discount         Float             @default(0)
  total            Float
  currency         String            @default("NAD")
  status           InvoiceStatus     @default(DRAFT)
  dueDate          DateTime
  paidDate         DateTime?
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  provider        User              @relation("ProviderInvoices", fields: [providerId], references: [id], onDelete: Cascade)
  patient         User              @relation("PatientInvoices", fields: [patientId], references: [id], onDelete: Cascade)
  payments                 Payment[]
  receipts                  Receipt[]

  @@index([providerId])
  @@index([patientId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([dueDate])
}

// Provider Fee Settings
model ProviderFee {
  id              String            @id @default(uuid())
  providerId      String            @unique
  consultationFee Float             @default(500) // Default consultation fee in NAD
  serviceFees     String?           // JSON object for different service fees
  currency        String            @default("NAD")
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  provider        User              @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([isActive])
}

// Payment Audit Log for Fraud Detection
model PaymentAuditLog {
  id              String            @id @default(uuid())
  paymentId       String
  action          String            // CREATED, APPROVED, REJECTED, REFUNDED, SUSPICIOUS
  userId          String?           // User who performed the action
  ipAddress       String?
  userAgent       String?
  details         String?           // JSON for additional details
  riskScore       Float?            // 0-1 risk score for fraud detection
  flagged         Boolean           @default(false)
  createdAt       DateTime          @default(now())

  payment         Payment           @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([action])
  @@index([flagged])
  @@index([createdAt])
}

// Two-Factor Authentication for Payments
model TwoFactorAuth {
  id              String            @id @default(uuid())
  userId          String            @unique
  secret          String            // Encrypted 2FA secret
  backupCodes     String?           // JSON array of backup codes (encrypted)
  isEnabled       Boolean           @default(false)
  lastUsed        DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Subscription Models
enum SubscriptionType {
  MONTHLY_WELLNESS
  STUDENT_RESEARCH
  PREMIUM_PATIENT
  PROVIDER_PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

model Subscription {
  id              String            @id @default(uuid())
  subscriberId    String            // User who subscribes
  type            SubscriptionType
  status          SubscriptionStatus @default(ACTIVE)
  startDate       DateTime          @default(now())
  endDate         DateTime
  autoRenew       Boolean           @default(true)
  price           Float
  currency        String            @default("NAD")
  discountCodeId  String?           // Applied discount code
  metadata        String?           // JSON for subscription details
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  subscriber      User              @relation("SubscriberSubscriptions", fields: [subscriberId], references: [id], onDelete: Cascade)
  discountCode    DiscountCode?     @relation(fields: [discountCodeId], references: [id], onDelete: SetNull)
  payments        SubscriptionPayment[]

  @@index([subscriberId])
  @@index([type])
  @@index([status])
  @@index([endDate])
}

model SubscriptionPayment {
  id              String            @id @default(uuid())
  subscriptionId  String
  userId          String
  amount          Float
  currency        String            @default("NAD")
  paymentMethod   PaymentMethod
  status          PaymentStatus     @default(PENDING)
  transactionId   String?
  dueDate         DateTime
  paidDate        DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  subscription    Subscription      @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

// Discount Codes and Promotions
enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model DiscountCode {
  id              String            @id @default(uuid())
  code            String            @unique
  description     String?
  discountType    DiscountType
  discountValue   Float             // Percentage (0-100) or fixed amount
  minPurchase     Float?            // Minimum purchase amount
  maxDiscount     Float?            // Maximum discount amount
  validFrom       DateTime
  validUntil      DateTime
  usageLimit      Int?              // Total usage limit
  usedCount       Int               @default(0)
  isActive        Boolean           @default(true)
  applicableTo     String?           // JSON array of applicable services/types
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  subscriptions   Subscription[]

  @@index([code])
  @@index([isActive])
  @@index([validFrom])
  @@index([validUntil])
}

// Digital Receipts
model Receipt {
  id              String            @id @default(uuid())
  invoiceId       String
  receiptNumber   String            @unique
  pdfUrl          String?           // URL to generated PDF receipt
  emailSent       Boolean           @default(false)
  smsSent         Boolean           @default(false)
  emailSentAt      DateTime?
  smsSentAt        DateTime?
  createdAt       DateTime          @default(now())

  invoice         BillingInvoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([receiptNumber])
}

// Provider Earnings and Payouts
enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model ProviderEarnings {
  id              String            @id @default(uuid())
  providerId      String
  periodStart     DateTime
  periodEnd       DateTime
  totalEarnings   Float
  platformFee     Float             // Platform commission
  netEarnings     Float              // Total - Platform fee
  currency        String            @default("NAD")
  payoutStatus    PayoutStatus      @default(PENDING)
  payoutDate       DateTime?
  transactionId   String?
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([providerId])
  @@index([payoutStatus])
  @@index([periodStart])
  @@index([periodEnd])
}

model RemoteMonitoringData {
  id              String            @id @default(uuid())
  patientId       String
  providerId      String?
  metricType      String            // BLOOD_PRESSURE, HEART_RATE, GLUCOSE, WEIGHT, etc.
  value           Float
  unit            String            // mmHg, bpm, mg/dL, kg, etc.
  deviceId        String?           // IoT device identifier
  deviceType      String?           // SMARTWATCH, GLUCOSE_METER, etc.
  recordedAt      DateTime          @default(now())
  notes           String?
  isAlert         Boolean           @default(false)
  alertLevel      String?           // LOW, NORMAL, HIGH, CRITICAL
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  patient         User              @relation("PatientMonitoring", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([providerId])
  @@index([metricType])
  @@index([recordedAt])
  @@index([isAlert])
}

// ========== RISK & CONSIDERATIONS: TRANSACTION LOGGING ==========

model TransactionLog {
  id              String            @id @default(uuid())
  transactionType String            // PAYMENT, REFUND, SUBSCRIPTION, etc.
  transactionId   String?           // Reference to related transaction
  userId          String?
  amount          Float?
  currency        String            @default("NAD")
  status          String            // SUCCESS, FAILED, PENDING, CANCELLED
  paymentMethod   String?
  gateway         String?           // PAYTODAY, SNAPSCAN, etc.
  gatewayTransactionId String?
  metadata        String?           // JSON for additional data
  ipAddress       String?
  userAgent       String?
  errorMessage    String?
  createdAt       DateTime          @default(now())

  @@index([transactionType])
  @@index([transactionId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([gateway])
}

// ========== RISK & CONSIDERATIONS: SURVEYS & FEEDBACK ==========

enum SurveyType {
  USER_SATISFACTION
  FEATURE_FEEDBACK
  ADOPTION_METRICS
  SUPPORT_SATISFACTION
  PLATFORM_FEEDBACK
}

enum SurveyStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

model Survey {
  id              String            @id @default(uuid())
  title           String
  description     String?
  surveyType      SurveyType
  status          SurveyStatus      @default(DRAFT)
  questions       String            // JSON array of questions
  targetAudience  String?           // JSON array of user roles
  startDate       DateTime?
  endDate         DateTime?
  isAnonymous     Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @default(now())

  responses       SurveyResponse[]

  @@index([surveyType])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model SurveyResponse {
  id              String            @id @default(uuid())
  surveyId        String
  userId          String?           // Null if anonymous
  responses       String            // JSON object with question-answer pairs
  metadata        String?           // JSON for additional data (device, location, etc.)
  completedAt     DateTime          @default(now())
  createdAt       DateTime          @default(now())

  survey          Survey            @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([userId])
  @@index([completedAt])
}

model UserFeedback {
  id              String            @id @default(uuid())
  userId          String?
  feedbackType    String            // BUG, FEATURE_REQUEST, COMPLIMENT, COMPLAINT, GENERAL
  category        String?           // UI, PERFORMANCE, FEATURE, SUPPORT, etc.
  title           String
  description     String
  rating          Int?              // 1-5 scale
  status          String            @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority        String?           // LOW, MEDIUM, HIGH, CRITICAL
  assignedTo      String?           // User ID of assignee
  resolution      String?
  resolvedAt      DateTime?
  metadata        String?           // JSON for additional data
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId])
  @@index([feedbackType])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// ========== RISK & CONSIDERATIONS: POLICY ENGINE ==========

enum PolicyType {
  DATA_RETENTION
  ACCESS_CONTROL
  CONSENT
  PAYMENT
  NOTIFICATION
  COMPLIANCE
}

model Policy {
  id              String            @id @default(uuid())
  policyType      PolicyType
  name            String
  description     String?
  policyData      String            // JSON object with policy configuration
  version         Int               @default(1)
  isActive        Boolean           @default(true)
  effectiveDate   DateTime          @default(now())
  expirationDate  DateTime?
  createdBy       String?           // User ID
  updatedBy       String?           // User ID
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([policyType])
  @@index([isActive])
  @@index([effectiveDate])
  @@index([expirationDate])
  @@unique([policyType, version])
}

